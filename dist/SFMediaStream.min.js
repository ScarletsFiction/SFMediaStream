/*
  SFMediaStream
  HTML5 media streamer library for playing music, video, playlist,
  or even live streaming microphone & camera with node server

  https://github.com/ScarletsFiction/SFMediaStream
*/
function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e,n){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?(module.exports={},n(module.exports,window,!0)):n(e,window)}(this||window,function(e,n,t){"use strict";var o={audioContext:!1,getElementAudioNode:function(e){return e.crossOrigin="anonymous",this.audioContext.createMediaElementSource(e)},getElementVideoNode:function(e){return e.crossOrigin="anonymous",null}},r={},a={webm:["opus","vorbis"],mp4:["mp4a.67","mp4a.40.29","mp4a.40.5","mp4a.40.2","mp3"],ogg:["opus","vorbis"]},i={webm:["vp8,opus","vp8,vorbis"],mp4:["mp4v.20.8,mp4a.40.2","mp4v.20.240,mp4a.40.2","avc1.42E01E,mp4a.40.2","avc1.58A01E,mp4a.40.2","avc1.64001E,mp4a.40.2"],"3gpp":["mp4v.20.8,samr"],ogg:["dirac,vorbis","theora,vorbis"]},c=[],u=!1;!function(){var e=n.AudioContext||n.webkitAudioContext;if(!e)return console.error("`AudioContext` was not available");o.audioContext=new e;var t=function(e){var n=o.audioContext.createBuffer(1,1,22050),t=o.audioContext.createBufferSource();t.buffer=n,t.connect(o.audioContext.destination),t.onended=function(){t.disconnect(0),t=n=null,r()},t.start?t.start(0):t.noteOn(0),o.audioContext.resume()};function r(){document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0);for(var e=0;e<c.length;e++)c[e]();c.length=0}document.addEventListener("touchstart",t,!0),document.addEventListener("touchend",t,!0),document.addEventListener("click",t,!0)}();var d=function(e){e||(e=1e3);var n=e/1e3,t=this;t.debug=!1,t.playing=!1,t.latency=0,t.mimeType=null,t.bufferElement=[],t.onStop=null,t.audioContext=o.audioContext,t.outputNode=!1;var r=!0,a=!1,i=!1,c=t.element=new Audio,u=t.audioContext.createMediaElementSource(c);c.addEventListener("error",function(e){console.error(e.target.error)}),t.connect=function(e){!0===r&&(r=!1,u.disconnect()),t.outputNode=t.audioContext.createGain(),t.outputNode.connect(e),u.connect(e)},t.disconnect=function(e){t.outputNode.disconnect(e),r=!0,u.disconnect(e),u.connect(t.audioContext.destination)},t.stop=function(){i.stop(),t.playing=!1,t.buffering=!1,t.onStop&&t.onStop()},t.setBufferHeader=function(n){if(n.data){var o=n.data;t.mimeType=n.mimeType,!1!==i?i.stop():u.connect(t.audioContext.destination),i=new s(t.mimeType,e,o),a=new Uint8Array(o),c.src=t.objectURL=i.objectURL,t.audioContext.decodeAudioData(o.slice(0),function(e){d=e.getChannelData(0).length})}else a=!1};var d=0;function l(e,n){var o;return t.bufferElement[e]=((o=t.audioContext.createBufferSource()).onended=function(){this.stop(),this.disconnect()},o),!1!==(n=function(e){var n=e.getChannelData(0).length-d;if(0===n)return!1;for(var o=e.numberOfChannels,r=t.audioContext.createBuffer(o,n,e.sampleRate),a=0;a<o;a++)r.getChannelData(a).set(e.getChannelData(a).subarray(d));return r}(n))&&(t.bufferElement[e].buffer=n,t.outputNode&&t.outputNode.context&&!1===r?t.bufferElement[e].connect(t.outputNode):t.bufferElement[e].connect(t.audioContext.destination),!0)}t.playStream=function(){t.playing=!0};var f=0;t.realtimeBufferPlay=function(e){if(!1!==t.playing){var o=e[0],r=e[1];if(t.debug&&console.log("Receiving data",o.byteLength),0!==o.byteLength){t.latency=Number(String(Date.now()).slice(-5,-3))-r+n+t.audioContext.baseLatency;var i=f;++f>2&&(f=0),t.audioContext.decodeAudioData(function(e){var n=new Uint8Array(a.byteLength+e.byteLength);return n.set(a,0),n.set(new Uint8Array(e),a.byteLength),n.buffer}(o),function(e){!1!==l(i,e)&&t.bufferElement[i].start(0)})}}},t.receiveBuffer=function(e){if(!1!==t.playing&&i.append){var o=e[0],r=e[1];i.append(o),c.paused&&c.play(),t.latency=Number(String(Date.now()).slice(-5,-3))-r+t.audioContext.baseLatency+n,t.debug&&console.log("Total latency: "+t.latency)}}},l={"audio/webm;codecs=opus":"GkXfo59ChoEBQveBAULygQRC84EIQoKEd2VibUKHgQRChYECGFOAZwH/////////FUmpZpkq17GDD0JATYCGQ2hyb21lV0GGQ2hyb21lFlSua7+uvdeBAXPFh7o5nyc1kHqDgQKGhkFfT1BVU2Oik09wdXNIZWFkAQIAAIC7AAAAAADhjbWERzuAAJ+BAmJkgSAfQ7Z1Af/////////ngQCjjIEAAID/A//+//7//qM="};o.convert={midiToFreq:function(e){return e<=-1500?0:e>1499?3.282417553401589e38:440*Math.pow(2,(Math.floor(e)-69)/12)},freqToMidi:function(e){return e>0?Math.floor(Math.log(e/440)/Math.LN2*12+69):-1500},powerToDb:function(e){if(e<=0)return 0;var n=100+10/Math.LN10*Math.log(e);return n<0?0:n},dbToPower:function(e){return e<=0?0:(e>870&&(e=870),Math.exp(.1*Math.LN10*(e-100)))},ampToDb:function(e){return 20*(e>1e-5?Math.log(e)/Math.LN10:-5)},dbToAmp:function(e){return Math.pow(10,e/20)},velToAmp:function(e){return e/127}};var s=function(e,n,t){var o=this;o.source=new MediaSource,o.objectURL=URL.createObjectURL(o.source);var r=!1,a=0,i=null,c=[];function u(e){i.appendBuffer(e),a+=n}o.source.onsourceopen=function(){(i=o.source.addSourceBuffer(e)).mode="sequence",i.appendBuffer(t),i.onerror=function(e){console.error("SourceBuffer error:",e)},i.onupdateend=function(){if(r)return r=!1,a=1e4,void i.remove(0,10);i.updating||0===c.length||u(c.shift())}},o.source.onerror=function(e){console.error("MediaSource error:",e)},o.append=function(e){return null!==i&&(i.updating||2!==i.buffered.length||console.log("something wrong"),a>=2e4&&(r=!0),i.updating?c.push(e):u(e),a/1e3)},o.stop=function(){i.updating&&i.abort(),"open"===o.source.readyState&&o.source.endOfStream()}},f=function(e){var n=this;if(void 0===e&&(e="audio"),e.constructor===String){if("audio"!==e&&"video"!==e)return console.error('Supported player is "audio" or "video"');e=document.createElement(e),document.body.appendChild(e)}var t=["autoplay","loop","buffered","buffered","controller","currentTime","currentSrc","duration","ended","error","readyState","networkState","paused","played","seekable","seeking"],r=!1;if(Object.defineProperty(n,"audioOutput",{get:function(){return r||(r=o.getElementAudioNode(e)),r},enumerable:!0}),"video"===e.tagName.toLowerCase()){t=t.concat(["poster","height","width"]);var a=!1;Object.defineProperty(n,"videoOutput",{get:function(){return a||(a=o.getElementVideoNode(e)),a},enumerable:!0})}n.load=function(){e.load()},n.canPlayType=function(){e.canPlayType()};for(var i=0;i<t.length;i++)o.extra.objectPropertyLinker(n,e,t[i]);n.preload=!0,e.preload="metadata",e.crossorigin="anonymous",n.audioFadeEffect=!0,n.speed=function(n){if(void 0===n)return e.defaultPlaybackRate;e.defaultPlaybackRate=e.playbackRate=n},n.mute=function(n){if(void 0===n)return e.muted;e.defaultMuted=e.muted=n},n.stop=function(){n.pause(),n.currentTime=0};var d=1;n.volume=function(n){if(void 0===n)return d;e.volume=d=n};var l=!1;function s(n,t){e.play().then(function(){l=!1,n&&n()}).catch(function(e){if(t)t(e);else{if(!1===u)return void(!1===l&&c.push(function(){s(n,t)}));console.error(e)}})}n.play=function(t,r){if(e.paused)return n.audioFadeEffect?(e.volume=0,s(t,r),void o.extra.fadeNumber(0,d,.02,400,function(n){e.volume=n},t)):void s(t,r);t&&t()},n.pause=function(t){e.paused?t&&t():n.audioFadeEffect?o.extra.fadeNumber(d,0,-.02,400,function(n){e.volume=n},function(){e.pause(),t&&t()}):(e.pause(),t&&t())},n.prepare=function(t,o,r){if(!r&&!e.paused)return n.pause(function(){n.prepare(t,o,!0)});for(var a=e.querySelectorAll("source"),i=a.length-1;i>=0;i--)a[i].remove();if(n.preload&&o&&(n.once("canplay",o),n.once("error",function(){n.off("canplay",o)})),"string"==typeof t)e.insertAdjacentHTML("beforeend",'<source src="'.concat(t.split('"').join('\\"'),'"/>'));else{a="";for(i=0;i<t.length;i++)a+='<source src="'.concat(t[i].split('"').join('\\"'),'"/>');e.insertAdjacentHTML("beforeend",a)}n.preload?e.load():o&&o()};var f={};function v(e){for(var t=0;t<f[e.type].length;t++)f[e.type][t](e,n)}n.on=function(t,o){var r=t.toLowerCase();return void 0===f[r]&&(e.addEventListener(t,v,!0),f[r]=[]),f[r].push(o),n},n.off=function(t,o){var r=t.toLowerCase();if(void 0!==f[r])return o?f[r].splice(f[r].indexOf(o),1):f[r].splice(0),0===f[r].length&&(f[r]=void 0,e.removeEventListener(t,v,!0)),n;e.removeEventListener(t,o,!0)},n.once=function(t,o){return e.addEventListener(t,o,{once:!0}),n},n.destroy=function(){for(var t in f)n.off(t);for(var t in n.playlist.list.splice(0),n.playlist.original.splice(0),n)delete n[t];n=null,e.pause(),e.innerHTML=""};var p=!1;function m(){p||(p=!0,n.on("ended",function(){n.playlist.currentIndex<n.playlist.list.length-1?n.playlist.next(!0):n.playlist.loop&&n.playlist.play(0)}))}function h(e){if(f[e])for(var t=0;t<f[e].length;t++)f[e][t](n,n.playlist,n.playlist.currentIndex)}n.playlist={currentIndex:0,list:[],original:[],loop:!1,shuffled:!1,reload:function(e){this.original=e,this.shuffle(this.shuffled),m()},add:function(e){this.original.push(e),this.shuffle(this.shuffled),m()},remove:function(e){this.original.splice(e,1),this.shuffle(this.shuffled)},next:function(e){if(this.currentIndex++,this.currentIndex>=this.list.length){if(!this.loop)return void this.currentIndex--;this.currentIndex=0}e?this.play(this.currentIndex):h("playlistchange")},previous:function(e){if(this.currentIndex--,this.currentIndex<0){if(!this.loop)return void this.currentIndex++;this.currentIndex=this.list.length-1}e?this.play(this.currentIndex):h("playlistchange")},play:function(e){this.currentIndex=e,h("playlistchange");var t=this.list[e].stream;n.currentSrc===t?n.play():n.prepare(this.list[e].stream,function(){n.play()})},shuffle:function(e){var n,t,o;if(!0===e)for(o=this.list.length-1;o>0;o--)n=Math.floor(Math.random()*(o+1)),t=this.list[o],this.list[o]=this.list[n],this.list[n]=t;else this.list=this.original.slice(0);this.shuffled=e}}},v=function(e,t){var r=this;t||(t=1e3),r.debug=!1,r.mediaStream=!1,r.onRecordingReady=null,r.onBufferProcess=null,r.onStop=null,r.mediaRecorder=null,r.recordingReady=!1,r.recording=!1,r.mediaGranted=!1,void 0===e&&(e={}),void 0!==e.element&&(e.mediaStream=e.element.captureStream()),r.debug=e.debug,r.workerOptions=e.workerOptions,r.options=e;var c=e.video?"video":"audio",u=n.MediaRecorder,d=!1;if(n.OpusMediaRecorder&&(d=!!e.alwaysUsePolyfill||(n.MediaRecorder?e.mimeType&&u.isTypeSupported(e.mimeType)?n.MediaRecorder===n.OpusMediaRecorder:e.mimeType?OpusMediaRecorder.isTypeSupported(e.mimeType):n.MediaRecorder===n.OpusMediaRecorder:OpusMediaRecorder.isTypeSupported(e.mimeType)))&&(u=OpusMediaRecorder,"video"===c&&console.log("opus-media-recorder does not support video recording.")),!u)throw"MediaRecorder is not available";if(e.mimeType&&!u.isTypeSupported(e.mimeType)&&(console.log("MediaRecorder doesn't supports mimetype "+e.mimeType),e.mimeType=null),!e.mimeType){var s=!1,f="audio"===c?a:i;for(var v in f){for(var p=c+"/"+v,m=f[v],h=0;h<m.length;h++){var y=p+";codecs="+m[h];if(u.isTypeSupported(y)&&MediaSource.isTypeSupported(y)){s=y;break}}if(!1===s&&u.isTypeSupported(p)&&MediaSource.isTypeSupported(p)&&(s=p),!1!==s)break}e.mimeType=s,r.debug&&console.log("mimeType: "+s)}var g=function(a){if(r.mediaGranted=!0,void 0!==e.audio)if(r.source=o.audioContext.createMediaStreamSource(a),r.mediaStream=a=r.destination.stream,0!==b.length){for(var i=0;i<b.length;i++)r.source.connect(b[i]);x=!1,b.length=0}else r.source.connect(r.destination);r.bufferHeader=null;var c=!1;r.mediaRecorder=d?new u(a,e,r.workerOptions):new u(a,e),r.debug&&console.log("MediaRecorder obtained"),r.mediaRecorder.onstart=function(e){r.recording=!0};var s=void 0!==e.video,f=s?565:100;r.mediaRecorder.ondataavailable=function(o){if(!1===c){if("recording"===r.mediaRecorder.state&&!(o.data.size<=1)){r.bufferHeader=o.data;var a=function(e){if(!n.chrome&&"audio/webm;codecs=opus"===e)return!1;var t=l[e];if(void 0===t)return!1;if(t.constructor===Blob)return t;t=atob(t);for(var o=new Uint8Array(t.length),r=0;r<t.length;r++)o[r]=t.charCodeAt(r);return l[e]=new Blob([o])}(r.mediaRecorder.mimeType);!1!==a&&(r.bufferHeader=a),((c=r.bufferHeader.size)>900||c<100)&&console.log("%c[WARN] The buffer header length was more than 0.9KB or smaller than 0.1KB. This sometime cause decode error on streamer side. Try to avoid any heavy CPU usage when using the recorder.","color:yellow"),r.onRecordingReady&&r.onRecordingReady({mimeType:e.mimeType,startTime:Date.now(),hasVideo:s,data:r.bufferHeader}),r.recordingReady=!0,t!==f&&(r.mediaRecorder.stop(),setTimeout(function(){r.mediaRecorder.start(t)},10))}}else{var i=Number(String(Date.now()).slice(-5,-3));r.onBufferProcess([o.data,i])}},r.mediaRecorder.start(f)},b=[];r.source=void 0,r.destination=o.audioContext.createMediaStreamDestination();var x=!0;function T(e){for(var n=e.getTracks(),o=0;o<n.length;o++)r.mediaRecorder.stream.addTrack(n[o]);r.mediaRecorder.start(t),r.recording=!0}r.connect=function(e){if(void 0!==r.source){if(x){try{r.source.disconnect(r.destination)}catch(e){}x=!1}r.source.connect(e)}else b.push(e)},r.disconnect=function(e){if(r.source)r.source.disconnect(e);else{var n=b.indexOf(e);if(-1===n)return;b.splice(n,1)}};var M=!1;r.startRecording=function(){return M?(M=!1,void(e.mediaStream||(r.options.screen?navigator.mediaDevices.getDisplayMedia(e).then(T).catch(console.error):navigator.mediaDevices.getUserMedia(e).then(T).catch(console.error)))):!1===r.mediaGranted||null===r.mediaRecorder?(r.recordingReady=!1,e.mediaStream?g(e.mediaStream):r.options.screen?navigator.mediaDevices.getDisplayMedia(e).then(g).catch(console.error):navigator.mediaDevices.getUserMedia(e).then(g).catch(console.error),!1):("recording"!==r.mediaRecorder.state&&(r.mediaRecorder.start(t),r.recording=!0),!0)},r.stopRecording=function(){if(r.recording&&r.mediaRecorder){if(r.recording=!1,r.mediaRecorder.stop(),!e.mediaStream)for(var n=r.mediaRecorder.stream.getTracks(),t=0;t<n.length;t++)n[t].stop(),r.mediaRecorder.stream.removeTrack(n[t]);r.bufferHeader=null,M=!0,r.onStop&&r.onStop()}}};v.isTypeSupported=function(e){return MediaSource.isTypeSupported(e)?!MediaRecorder||!MediaRecorder.isTypeSupported(e)||n.OpusMediaRecorder&&!n.OpusMediaRecorder.isTypeSupported(e)?"MediaRecorder is not supporting this type":"Maybe supported":"MediaSource is not supporting this type"},r.chorus=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createGain(),i=n.createGain(),c=n.createChannelSplitter(2),u=n.createChannelMerger(2);e.connect(c),e.connect(a);for(var d=[{},{}],l=0;l<d.length;l++){var s=d[l];s.stream=n.createGain(),s.delayVibrato=n.createDelay(),s.delayFixed=n.createDelay(),s.feedback=n.createGain(),s.feedforward=n.createGain(),s.blend=n.createGain(),c.connect(s.stream,l,0),s.stream.connect(s.delayVibrato),s.stream.connect(s.delayFixed),s.delayVibrato.connect(s.feedforward),s.delayVibrato.connect(u,0,l),s.delayFixed.connect(s.feedback),s.feedback.connect(s.stream),s.blend.connect(u,0,l)}u.connect(i),a.connect(t),i.connect(t);var f=n.createOscillator(),v=n.createGain(),p=n.createGain();f.connect(v),f.connect(p),v.connect(d[0].delayVibrato.delayTime),p.connect(d[1].delayVibrato.delayTime),f.start(0),f.type="sine",f.frequency.value=.15,v.gain.value=.013,p.gain.value=-.017,d[0].delayFixed.delayTime.value=.005,d[1].delayFixed.delayTime.value=.007,d[0].delayVibrato.delayTime.value=.013,d[1].delayVibrato.delayTime.value=.017;var m={rate:0,intensity:0,mix:0},h={output:t,input:r,rate:function(e){if(void 0===e)return m.rate;m.rate=e,e=.29*e+.01,f.frequency.value=e},intensity:function(e){if(void 0===e)return m.intensity;m.intensity=e;for(var n=1-.2929*e,t=.2929*e+.7071,o=.7071*e,r=0;r<d.length;r++)d[r].blend.gain.value=n,d[r].feedforward.gain.value=t,d[r].feedback.gain.value=o},mix:function(e){if(void 0===e)return m.mix;m.mix=e,a.gain.value=e},destroy:function(){r&&r.disconnect(),t.disconnect(),f.stop(0),f.disconnect();for(var e=0;e<d.length;e++)d[e].stream.disconnect();for(var n in this)delete this[n];t=null}};return h.rate(.5),h.intensity(0),h.mix(.75),h},r.conReverb=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createConvolver(),i=n.createGain(),c=n.createGain();function u(t){null!==a.buffer&&(a.disconnect(),a=n.createConvolver(),e.connect(a),a.connect(i)),a.buffer=t}return e.connect(c),e.connect(a),a.connect(i),c.connect(t),i.connect(t),{output:t,input:r,setBuffer:u,loadBuffer:function(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(){var e=t.response;n.decodeAudioData(e,function(e){u(e)},function(e){e.err})},t.send()},mix:function(e){if(void 0===e)return i.gain.value;c.gain.value=1-e,i.gain.value=e},destroy:function(){for(var e in r&&r.disconnect(),c.disconnect(),t.disconnect(),a.disconnect(),this)delete this[e];t=null}}},r.cutOff=function(e,n){var t=o.audioContext,r=t.createGain(),a=void 0===n?t.createGain():null;a&&(n=a);var i=t.createBiquadFilter();return i.type=e||"lowpass",i.frequency.value=350,i.Q.value=1,i.connect(r),n.connect(i),{output:r,input:a,type:function(e){if(void 0===e)return i.type;i.type=e},frequency:function(e){if(void 0===e)return i.frequency.value;i.frequency.value=e},width:function(e){if(void 0===e)return i.Q.value;i.Q.value=e},destroy:function(){for(var e in a&&a.disconnect(),i.disconnect(),r.disconnect(),this)delete this[e];r=null}}},r.delay=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createGain(),i=n.createGain(),c=n.createGain(),u=n.createDelay();e.connect(a),a.connect(t),u.connect(c),c.connect(u),e.connect(u),u.connect(i),i.connect(t);var d={output:t,input:r,mix:function(e){if(void 0===e)return i.gain.value;a.gain.value=1-e,i.gain.value=e},time:function(e){if(void 0===e)return u.delayTime.value;u.delayTime.value=e},feedback:function(e){if(void 0===e)return c.gain.value;c.gain.value=e},destroy:function(){for(var e in r&&r.disconnect(),t.disconnect(),a.disconnect(),i.disconnect(),c.disconnect(),u.disconnect(),this)delete this[e];t=null}};return d.mix(.5),d.time(.3),d.feedback(.5),d},r.distortion=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=57*Math.PI/180,i=n.createWaveShaper();i.connect(t),e.connect(i);var c={amount:0};return{set:function(e){if(void 0===e)return c.amount;c.amount=e,e*=10;for(var t=new Float32Array(n.sampleRate),o=2/n.sampleRate,r=0;r<n.sampleRate;r++){var u=r*o-1;t[r]=(3+e)*u*a/(Math.PI+e*Math.abs(u))}i.curve=t},output:t,input:r,destroy:function(){for(var e in r&&r.disconnect(),i.disconnect(),t.disconnect(),i=t=null,this)delete this[e]}}},r.dubDelay=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createGain(),i=n.createGain(),c=n.createGain(),u=n.createDelay(),d=n.createBiquadFilter();e.connect(a),a.connect(t),e.connect(i),e.connect(c),c.connect(d),d.connect(u),u.connect(c),u.connect(i),i.connect(t);var l={output:t,input:r,mix:function(e){if(void 0===e)return i.gain.value;a.gain.value=1-e,i.gain.value=e},time:function(e){if(void 0===e)return u.delayTime.value;u.delayTime.value=e},feedback:function(e){if(void 0===e)return c.gain.value;c.gain.value=e},cutoff:function(e){if(void 0===e)return d.frequency.value;d.frequency.value=e},destroy:function(){for(var e in r&&r.disconnect(),t.disconnect(),a.disconnect(),i.disconnect(),c.disconnect(),this)delete this[e];t=null}};return l.mix(.5),l.time(.7),l.feedback(.6),l.cutoff(700),l},r.equalizer=function(e,n){var t=e||[32,64,125,250,500,1e3,2e3,4e3,8e3,16e3],r=o.audioContext,a=r.createGain(),i=void 0===n?r.createGain():null;i&&(n=i);for(var c={},u=t.length-1,d=0;d<t.length;d++){var l=r.createBiquadFilter();l.gain.value=0,l.frequency.value=t[d],l.type=0===d?"lowshelf":d===u?"highshelf":"peaking",0!==d&&c[t[d-1]].connect(l),c[t[d]]=l}return n.connect(c[t[0]]),l.connect(a),{output:a,input:i,frequency:function(e,n){if(void 0===n)return c[e].gain.value;c[e].gain.value=n},destroy:function(){for(var e=0;e<t.length;e++)c[t[e]].disconnect();for(var n in c.splice(0),i&&i.disconnect(),a.disconnect(),this)delete this[n];c=a=null}}},r.fade=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;return r&&(e=r),t.gain.value=1,e.connect(t),{output:t,input:r,in:function(e,o,r){t.gain.cancelScheduledValues(n.currentTime);var a=(1-t.gain.value)*e;t.gain.setTargetAtTime(1,n.currentTime,a*o),r&&setTimeout(r,1e3*o)},out:function(e,o,r){t.gain.cancelScheduledValues(n.currentTime);var a=t.gain.value*e;t.gain.setTargetAtTime(1e-5,n.currentTime,a/o),r&&setTimeout(r,1e3*o)},destroy:function(){for(var e in r&&r.disconnect(),t.disconnect(),this)delete this[e];t=null}}},r.flanger=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createGain(),i=n.createGain(),c=n.createGain(),u=n.createDelay(),d=n.createOscillator(),l=n.createGain(),s=n.createGain();d.type="sine",e.connect(a),e.connect(c),a.connect(u),a.connect(i),u.connect(i),u.connect(s),s.connect(a),d.connect(l),l.connect(u.delayTime),c.connect(t),i.connect(t),d.start(0);var f={output:t,input:r,mix:function(e){if(void 0===e)return i.gain.value;c.gain.value=1-e,i.gain.value=e},time:function(e){if(void 0===e)return o.extra.denormalize(u.delayTime.value,.001,.02);u.delayTime.value=o.extra.normalize(e,.001,.02)},speed:function(e){if(void 0===e)return o.extra.denormalize(u.delayTime.value,.5,5);d.frequency.value=o.extra.normalize(e,.5,5)},depth:function(e){if(void 0===e)return o.extra.denormalize(u.delayTime.value,5e-4,.005);l.gain.value=o.extra.normalize(e,5e-4,.005)},feedback:function(e){if(void 0===e)return o.extra.denormalize(u.delayTime.value,0,.8);s.gain.value=o.extra.normalize(e,0,.8)},destroy:function(){for(var e in r&&r.disconnect(),t.disconnect(),a.disconnect(),c.disconnect(),this)delete this[e];t=null}};return f.time(.45),f.speed(.2),f.depth(.1),f.feedback(.1),f.mix(.5),f},r.harmonizer=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);for(var a=[],i=[],c=[],u=0;u<8;u++)a[u]=n.createBiquadFilter(),a[u].type="bandpass",i[u]=n.createBiquadFilter(),i[u].type="bandpass",e.connect(a[u]),c[u]=n.createGain(),c[u].connect(t),a[u].connect(i[u]).connect(c[u]);t.gain.value=35;var d={pitch:0,slope:0,width:0},l={output:t,input:r,pitch:function(e){if(void 0===e)return d.pitch;d.pitch=e;for(var n=o.convert.midiToFreq(e),t=0;t<8;t++)a[t].frequency.value=n,i[t].frequency.value=n},slope:function(e){if(void 0===e)return d.slope;d.slope=e;for(var n=0;n<8;n++)c[n].gain.value=1+Math.sin(Math.PI+Math.PI/2*(e+n/8))},width:function(e){if(void 0===e)return d.width;d.width=e;for(var n=1;n<8;n++){var t=2+90*Math.pow(1-n/8,e);a[n].Q.value=t,i[n].Q.value=t}},destroy:function(){r&&r.disconnect(),t.disconnect();for(var e=0;e<8;e++)a[e].disconnect();for(var n in this)delete this[n];t=null}};return l.pitch(34),l.slope(.65),l.width(.15),l},r.noise=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);for(var a=Math.floor(9.73*n.sampleRate),i=new Float32Array(a),c=0;c<a;c++)i[c]=Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random())*.5;var u=n.createBuffer(2,a,n.sampleRate);u.getChannelData(0).set(i,0),u.getChannelData(1).set(i,0);var d=n.createBufferSource();return d.to(t),d.loop=!0,d.start(0),d.buffer=u,d.loopStart=9.73*Math.random(),{output:t,input:r,destroy:function(){for(var e in d.loop=!1,d.buffer=null,d.stop(0),d.disconnect(),d=null,r&&r.disconnect(),t.disconnect(),this)delete this[e];t=null}}},r.pingPongDelay=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createDelay(),i=n.createDelay(),c=n.createGain(),u=n.createGain(),d=n.createGain(),l=n.createChannelMerger(2);e.connect(c),c.connect(t),a.connect(l,0,0),i.connect(l,0,1),a.connect(i),d.connect(a),i.connect(d),e.connect(d),l.connect(u),u.connect(t);var s={output:t,input:r,mix:function(e){if(void 0===e)return u.gain.value;c.gain.value=1-e,u.gain.value=e},time:function(e){if(void 0===e)return a.delayTime.value;a.delayTime.value=e,i.delayTime.value=e},feedback:function(e){if(void 0===e)return d.gain.value;d.gain.value=e},destroy:function(){for(var e in r&&r.disconnect(),t.disconnect(),c.disconnect(),d.disconnect(),this)delete this[e];t=null}};return s.mix(.5),s.time(.3),s.feedback(.5),s},r.pitchShift=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=.1,i=a/2,c=a*n.sampleRate,u=n.createGain(),d=n.createGain(),l=n.createDelay(),s=n.createDelay();u.connect(l.delayTime),d.connect(s.delayTime),e.connect(l),e.connect(s);var f=n.currentTime+i,v=n.currentTime+a;function p(e){for(var t=n.createBuffer(1,c,n.sampleRate),o=t.getChannelData(0),r=0;r<c;r++)o[r]=e?(c-r)/c:r/c;return t}for(var m=[0,0,0,0],h=[0,0,0,0],y=0;y<m.length;y++)m[y]=n.createBufferSource(),m[y].loop=!0,h[y]=n.createGain(),y<2?m[y].buffer=p(!1):(m[y].buffer=p(!0),h[y].gain.value=0),y%2?(h[y].connect(d),m[y].start(v)):(h[y].connect(u),m[y].start(f)),m[y].connect(h[y]);var g=function(){for(var e=n.createBuffer(1,c,n.sampleRate),t=e.getChannelData(0),o=i*n.sampleRate,r=c-o,a=0;a<c;a++)t[a]=a<o?Math.sqrt(a/o):Math.sqrt(1-(a-r)/o);return e}(),b=[0,0],x=[0,0];for(y=0;y<b.length;y++)b[y]=n.createBufferSource(),b[y].loop=!0,b[y].buffer=g,x[y]=n.createGain(),x[y].gain.value=0,b[y].connect(x[y].gain),y%2?(h[y].connect(d),b[y].start(v)):(h[y].connect(u),b[y].start(f)),x[y].connect(t);function T(e){u.gain.value=d.gain.value=.5*a*Math.abs(e)}l.connect(x[0]),s.connect(x[1]);var M={output:t,input:r,shift:function(e){if(void 0!==e){var n=e>0;h[0].gain.value=h[1].gain.value=n?0:1,h[2].gain.value=h[3].gain.value=n?1:0,T(e)}},destroy:function(){r&&r.disconnect(),t.disconnect();for(var e=0;e<b.length;e++)b[e].stop(),b[e].disconnect(),x[e].disconnect();for(e=0;e<m.length;e++)m[e].stop(),m[e].disconnect(),h[e].disconnect();for(var n in u.disconnect(),d.disconnect(),l.disconnect(),s.disconnect(),this)delete this[n];t=null}};return T(0),M},r.reverb=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createConvolver(),i=n.createGain(),c=n.createGain();e.connect(c),c.connect(t),i.connect(t);var u=1,d=.1,l=!1;function s(){for(var t=n.sampleRate*u,o=n.createBuffer(2,t,n.sampleRate),r=o.getChannelData(0),c=o.getChannelData(1),s=0;s<t;s++){var f=l?t-s:s;r[s]=(2*Math.random()-1)*Math.pow(1-f/t,d),c[s]=(2*Math.random()-1)*Math.pow(1-f/t,d)}a.disconnect(),a=n.createConvolver(),e.connect(a),a.connect(i),a.buffer=o}return s(),{output:t,input:r,mix:function(e){if(void 0===e)return i.gain.value;c.gain.value=1-e,i.gain.value=e},time:function(e){if(void 0===e)return u;u=e,s()},decay:function(e){if(void 0===e)return d;d=e,s()},reverse:function(e){if(void 0===e)return l;l=e,s()},destroy:function(){for(var e in r&&r.disconnect(),c.disconnect(),t.disconnect(),a.disconnect(),this)delete this[e];t=null}}},r.stereoPanner=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=!1;if(n.createStereoPanner){var i=n.createStereoPanner();a=!0}else{(i=n.createPanner()).type="equalpower"}return e.connect(i),i.connect(t),i.pan.value=0,{output:t,input:r,set:function(e){if(void 0===e)return i.pan.value;a?i.pan.value=e:i.setPosition(e,0,1-Math.abs(e))},destroy:function(){for(var e in r&&r.disconnect(),t.disconnect(),i.disconnect(),this)delete this[e];t=i=null}}},r.tremolo=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r);var a=n.createGain(),i=n.createGain(),c=n.createGain();c.gain.value=0;var u=n.createWaveShaper();u.curve=new Float32Array([0,1]),u.connect(c.gain),e.connect(a),a.connect(t);var d=n.createOscillator();d.connect(u),d.type="sine",d.start(0),e.connect(c),c.connect(i),i.connect(t);var l={output:t,input:r,mix:function(e){if(void 0===e)return i.gain.value;a.gain.value=1-e,i.gain.value=e},speed:function(e){if(void 0===e)return o.extra.denormalize(d.frequency.value,0,20);d.frequency.value=o.extra.normalize(e,0,20)},depth:function(e){if(void 0===e)return 1-this.shaperNode.curve[0];u.curve=new Float32Array([1-e,1])},destroy:function(){for(var e in r&&r.disconnect(),t.disconnect(),a.disconnect(),c.disconnect(),this)delete this[e];t=null}};return l.speed(.2),l.depth(1),l.mix(.8),l},r.vibrato=function(e){var n=o.audioContext,t=n.createGain(),r=void 0===e?n.createGain():null;r&&(e=r),console.log("Vibrato was not finished yet");var a=n.createDelay(),i=n.createGain(),c=n.createGain(),u=n.createOscillator();return e.connect(c),c.connect(t),i.connect(t),a.delayTime.value=1,u.frequency.value=3,u.type="sine",u.start(0),u.connect(a.delayTime),e.connect(a),a.connect(i),{output:t,input:r,mix:function(e){if(void 0===e)return i.gain.value;c.gain.value=1-e,i.gain.value=e},delay:function(e){if(void 0===e)return a.delayTime.value;a.delayTime.value=e},depth:function(e){if(void 0===e)return depthNode.gain.value;depthNode.gain.value=e},speed:function(e){if(void 0===e)return u.frequency.value;u.frequency.value=e},destroy:function(){for(var n in r&&r.disconnect(),t.disconnect(),e.disconnect(a),e.disconnect(c),u.stop(),u.disconnect(),depthNode.disconnect(),this)delete this[n];t=null}}};var p=function(e,n){n||(n=1e3);var t=n/1e3,r=this;r.debug=!1,r.playing=!1,r.latency=0,r.mimeType=null,r.audioContext=o.audioContext,r.outputNode=!1;var a=!0,i=!1,c=r.audioContext.createMediaElementSource(e);e.addEventListener("error",function(e){console.error(e.target.error)}),r.audioConnect=function(e){!0===a&&(a=!1,c.disconnect()),r.outputNode=r.audioContext.createGain(),r.outputNode.connect(e),c.connect(e)},r.audioDisconnect=function(){outputNode.disconnect(),a=!0,c.disconnect(),c.connect(r.audioContext.destination)},r.stop=function(){i.stop(),r.playing=!1,r.buffering=!1},r.setBufferHeader=function(t){if(t&&t.data){var o=t.data;r.mimeType=t.mimeType,!1!==i?i.stop():c.connect(r.audioContext.destination),i=new s(r.mimeType,n,o),e.src=r.objectURL=i.objectURL}},r.playStream=function(){r.playing=!0},r.receiveBuffer=function(n){if(!1!==r.playing&&i.append){var o=n[0],a=n[1];i.append(o),e.paused&&e.play(),r.latency=Number(String(Date.now()).slice(-5,-3))-a+r.audioContext.baseLatency+t,r.debug&&console.log("Total latency: "+r.latency)}}};o.extra=new function(){this.isMobile=function(){return/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(navigator.userAgent)},this.objectPropertyLinker=function(e,n,t){Object.defineProperty(e,t,{get:function(){return n[t]},set:function(e){n[t]=e},enumerable:!0,configurable:!0})},this.normalize=function(e,n,t){return(t-n)*e+n},this.denormalize=function(e,n,t){return(e-n)/(t-n)};var e=0;this.fadeNumber=function(n,t,o,r,a,i){e=0;var c=n,u=r/(Math.abs(n-t)/Math.abs(o));if(u&&u!=1/0)var d=setInterval(function(){if(e>=100&&clearInterval(d),e++,c=1e3*(c+o),c=Math.ceil(c)/1e3,o>=0&&(c>=t||n>=t)||o<=0&&(c<=t||n<=t)||c==1/0||!c)return clearInterval(d),a(t),void(i&&i());a&&a(c)},u);else setTimeout(function(){a&&a(t),i&&i()},r)};var n=[],t=0;this.preciseTimeout=function(e,o){var r=Date.now();return t++,n.push({id:t,when:r+o,func:e,fallback:setTimeout(function(){a(t).func()},o)}),c(),t},this.clearPreciseTimeout=function(e){a(e,n)};var o=[],r=0;function a(e,n){for(var t in n)if(n[t].id===e)return n.splice(t,1)}this.preciseInterval=function(e,n){var t=Date.now(),a={id:++r,interval:n,when:t+n,func:e};return a.fallback=setInterval(function(){a.when>=Date.now()||(a.when+=a.interval,a.func())},n),o.push(a),c(),r},this.clearPreciseInterval=function(e){var n=a(e,o);clearInterval(n.fallback)};var i=!1;function c(){if(!i){i=!0;requestAnimationFrame(function e(){if(0!==n.length||0!==o.length){requestAnimationFrame(e);var t=Date.now();for(var r in n)n[r].when<t&&(n[r].func(),clearTimeout(n[r].fallback),n.splice(r,1));for(var r in o)o[r].when<t&&(o[r].func(),o[r].when+=o[r].interval)}else i=!1})}}},t?(e.Media=o,e.MediaEffect=r,e.AudioStreamer=d,e.VideoStreamer=p,e.MediaPlayer=f,e.MediaPresenter=v,e.ScarletsMediaBuffer=s):(e.ScarletsMedia=o,e.ScarletsMediaEffect=r,e.ScarletsAudioStreamer=d,e.ScarletsVideoStreamer=p,e.ScarletsMediaPlayer=f,e.ScarletsMediaPresenter=v,e.ScarletsMediaBuffer=s)});
//# sourceMappingURL=SFMediaStream.min.js.map
