/*
  SFMediaStream
  HTML5 media streamer library for playing music, video, playlist,
  or even live streaming microphone & camera with node server

  https://github.com/ScarletsFiction/SFMediaStream
*/
if(window.ScarletsAudioBufferStreamer=function(e,r){(!e||e<3)&&(e=3),r||(r=1e3);var i=this;i.debug=!1,i.bufferElement=[],i.bufferAvailable=[],i.bufferPending=[],i.currentBuffer=0,i.playing=!1,i.buffering=!1,i.streaming=!1,i.currentDuration=!1,i.latency=0,i.error=0,i.realtime=!1,i.bufferSkip=.07,i.mimeType=null,i.webAudio=!!isMobile(),i.audioContext=ScarletsMedia.audioContext;var o=!1;i.setBufferHeader=function(e){e?(o=e,e.byteLength,i.audioContext&&i.audioContext.decodeAudioData(e.slice(0),function(e){i.bufferSkip=e.duration})):o=!1};for(var t=function(e){i.bufferElement[e].onended=function(){i.debug&&console.log("Buffer ended with ID: "+e),i.webAudio?this.disconnect(0):(URL.revokeObjectURL(i.bufferElement[e].src),i.bufferElement[e].src=""),i.realtime||(i.bufferAvailable[e]=!1,i.playing=!1,i.buffering=!0,i.playAvailable(),-1!=i.bufferAvailable.indexOf(!1)&&0!=i.bufferPending.length&&c())}},n=0;n<e;n++)a(n);function a(e){if(i.webAudio)i.bufferElement.push(i.audioContext.createBufferSource()),i.bufferAvailable.push(!1);else{var r=new Audio;r&&(i.bufferElement.push(r),i.bufferAvailable.push(!1),t(e))}}function d(e,r){var o=i.bufferElement[e].onended;i.bufferElement[e]=i.audioContext.createBufferSource(),i.bufferElement[e].buffer=r,i.bufferElement[e].connect(i.audioContext.destination),i.bufferElement[e].onended=o}i.receiveBuffer=function(o){if(i.debug&&console.log("Receiving data",o[0].byteLength),i.streaming){var t=o[1];if(i.realtime=!1,r){for(var n=i.bufferPending.length,a=0;a<e;a++)i.bufferAvailable[a]&&n++;i.latency=Number(String(Date.now()).slice(-5,-3))-t+r*n+i.audioContext.baseLatency,i.debug&&console.log("Total latency: "+i.latency)}i.bufferPending.push(o[0]),c(),i.buffering&&i.playAvailable()}};var u=new FileReader,f=0;i.realtimeBufferPlay=function(e){i.debug&&console.log("Receiving data",e[0].byteLength),i.latency=Number(String(Date.now()).slice(-5,-3))-e[1]+r/1e3+i.audioContext.baseLatency,i.realtime=!0;var t=f;++f>2&&(f=0),i.webAudio?(u.onload=function(){i.audioContext.decodeAudioData(this.result,function(e){d(t,e),i.bufferElement[t].start(i.bufferSkip)})},u.readAsArrayBuffer(new Blob([o,e[0]],{type:i.mimeType}))):(URL.revokeObjectURL(i.bufferElement[t].src),i.bufferElement[t].src=URL.createObjectURL(new Blob([o,e[0]],{type:i.mimeType})),i.bufferElement[t].load(),i.bufferElement[t].play(),i.bufferElement[t].currentTime=i.bufferSkip)};var c=function(){var e=i.bufferAvailable.indexOf(!1,i.currentBuffer);-1==e&&(e=i.bufferAvailable.indexOf(!1)),-1!=e&&0!=i.bufferPending.length&&(i.webAudio?(u.onload=function(){i.audioContext.decodeAudioData(this.result,function(r){d(e,r)})},u.readAsArrayBuffer(new Blob([o,i.bufferPending[0]],{type:i.mimeType}))):(i.bufferElement[e].src=URL.createObjectURL(new Blob([o,i.bufferPending[0]],{type:i.mimeType})),i.bufferElement[e].load()),i.bufferPending.shift(),i.bufferAvailable[e]=!0,i.buffering&&i.playAvailable(),i.debug&&console.log("Buffer updated with ID: "+e))};i.playBuffer=function(e){i.bufferElement[e].duration&&(i.debug&&console.log("Current stream duration: "+i.bufferElement[e].duration),!1!==r?(i.buffering=!1,i.playing=!0,r=i.bufferElement[e].duration,i.bufferElement[e].start?i.bufferElement[e].start(i.bufferSkip):(i.bufferElement[e].play(),i.bufferElement[e].currentTime=i.bufferSkip),i.currentBuffer=e,i.debug&&console.log("Playing buffer ID: "+i.currentBuffer)):r=i.bufferElement[e].duration)},i.playAvailable=function(){if(!i.playing){if(i.bufferAvailable[i.currentBuffer])return i.playBuffer(i.currentBuffer);var e=i.bufferAvailable.indexOf(!0,i.currentBuffer);return-1!=e?i.playBuffer(e):-1!=(e=i.bufferAvailable.indexOf(!0))?i.playBuffer(e):void 0}},i.playStream=function(){i.streaming=i.buffering=!0},i.stop=function(){i.bufferPending.splice(0);for(var r=0;r<e;r++)i.bufferElement[r].stop(),t(r),i.bufferAvailable[r]=!1;i.playing=!1,i.buffering=!1,i.currentBuffer=0}},window.ScarletsMedia={audioContext:!!window.AudioContext&&new AudioContext},window.ScarletsMediaPlayer=function(e){var r=this,i=["autoplay","loop","buffered","buffered","controller","currentTime","currentSrc","duration","ended","error","readyState","networkState","paused","played","seekable","seeking"];"video"===e.tagName.toLowerCase()&&(i=i.concat(["poster","height","width"])),r.load=function(){e.load()},r.canPlayType=function(){e.canPlayType()};for(var o=0;o<i.length;o++)objectPropertyLinker(r,e,i[o]);r.preload=!0,e.preload="metadata",r.audioFadeEffect=!0,r.speed=function(r){if(void 0===r)return e.defaultPlaybackRate;e.defaultPlaybackRate=e.playbackRate=r},r.mute=function(r){if(void 0===r)return e.muted;e.defaultMuted=e.muted=r};var t=1;r.volume=function(r){if(void 0===r)return t;e.volume=t=r},r.play=function(i){if(e.paused){if(r.audioFadeEffect)return e.volume=0,e.play(),void fadeNumber(0,t,.02,400,function(r){e.volume=r},i);e.play(),i&&i()}else i&&i()},r.pause=function(i){e.paused?i&&i():r.audioFadeEffect?fadeNumber(t,0,-.02,400,function(r){e.volume=r},function(){e.pause(),i&&i()}):(e.pause(),i&&i())},r.prepare=function(i,o,t){if(!t&&!e.paused)return r.pause(function(){r.prepare(i,o,!0)});for(var n=e.querySelectorAll("source"),a=n.length-1;a>=0;a--)n[a].remove();if("string"==typeof i)e.insertAdjacentHTML("beforeend",'<source src="'+i+'"/>');else{n="";for(a=0;a<i.length;a++)n+='<source src="'+i[a]+'"/>';e.insertAdjacentHTML("beforeend",n)}r.preload&&e.load(),o&&o()};var n={};function a(e){for(var i=0;i<n[e.type].length;i++)n[e.type][i](e,r)}r.on=function(i,o){var t=i.toLowerCase();return void 0===n[t]&&(e.addEventListener(i,a,!0),n[t]=[]),n[t].push(o),r},r.off=function(i,o){var t=i.toLowerCase();if(void 0!==n[t])return o?n[t].splice(n[t].indexOf(o),1):n[t].splice(0),0===n[t].length&&(n[t]=void 0,e.removeEventListener(i,a,!0)),r},r.once=function(i,o){return e.addEventListener(i,o,{once:!0}),r},r.destroy=function(){for(var i in n)r.off(i);for(var i in r.playlist.list.splice(0),r.playlist.original.splice(0),r)delete r[i];r=null,e.pause(),e.innerHTML=""};var d=!1;function u(){d||(d=!0,r.on("ended",function(){r.playlist.currentIndex<r.playlist.list.length-1?r.playlist.next(!0):r.playlist.loop&&r.playlist.play(0)}))}function f(e){if(n[e])for(var i=0;i<n[e].length;i++)n[e][i](r,r.playlist,r.playlist.currentIndex)}r.playlist={currentIndex:0,list:[],original:[],loop:!1,shuffled:!1,reload:function(e){this.original=e,this.shuffle(this.shuffled),u()},add:function(e){this.original.push(e),this.shuffle(this.shuffled),u()},remove:function(e){this.original.splice(e,1),this.shuffle(this.shuffled)},next:function(e){if(this.currentIndex++,this.currentIndex>=this.list.length){if(!this.loop)return void this.currentIndex--;this.currentIndex=0}e?this.play(this.currentIndex):f("playlistchange")},previous:function(e){if(this.currentIndex--,this.currentIndex<0){if(!this.loop)return void this.currentIndex++;this.currentIndex=this.list.length-1}e?this.play(this.currentIndex):f("playlistchange")},play:function(e){this.currentIndex=e,f("playlistchange"),r.prepare(this.list[e].stream,function(){r.play()})},shuffle:function(e){var r,i,o;if(!0===e)for(o=this.list.length-1;o>0;o--)r=Math.floor(Math.random()*(o+1)),i=this.list[o],this.list[o]=this.list[r],this.list[r]=i;else this.list=this.original.slice(0);this.shuffled=e}}},window.ScarletsMediaPresenter=function(e,r){var i=this;r||(r=1e3),i.debug=!1,i.onRecordingReady=null,i.onBufferProcess=null,i.mediaRecorder=null,i.recordingReady=!1,i.recording=!1,i.mediaGranted=!1;var o=new FileReader;i.options={},e.audio&&!e.video?MediaRecorder.isTypeSupported('audio/webm;codecs="vp9"')?i.options.mimeType='audio/webm;codecs="vp9"':MediaRecorder.isTypeSupported('audio/webm;codecs="vp8"')?i.options.mimeType='audio/webm;codecs="vp8"':MediaRecorder.isTypeSupported('audio/webm;codecs="vorbis"')?i.options.mimeType='audio/webm;codecs="vorbis"':MediaRecorder.isTypeSupported("audio/webm")?i.options.mimeType="audio/webm":MediaRecorder.isTypeSupported('audio/ogg;codecs="opus"')?i.options.mimeType='audio/ogg;codecs="opus"':MediaRecorder.isTypeSupported('audio/ogg;codecs="vorbis"')?i.options.mimeType='audio/ogg;codecs="vorbis"':MediaRecorder.isTypeSupported("audio/ogg")?i.options.mimeType="audio/ogg":MediaRecorder.isTypeSupported('audio/mp4;codecs="mp4a.40.5')?i.options.mimeType='audio/mp4;codecs="mp4a.40.5':MediaRecorder.isTypeSupported("audio/mp4")&&(i.options.mimeType="audio/mp4"):!e.audio&&e.video?MediaRecorder.isTypeSupported('video/webm;codecs="vp9"')?i.options.mimeType='video/webm;codecs="vp9"':MediaRecorder.isTypeSupported('video/webm;codecs="vp8"')?i.options.mimeType='video/webm;codecs="vp8"':MediaRecorder.isTypeSupported('video/webm;codecs="vorbis"')?i.options.mimeType='video/webm;codecs="vorbis"':MediaRecorder.isTypeSupported("video/webm")?i.options.mimeType="video/webm":MediaRecorder.isTypeSupported('video/ogg;codecs="opus"')?i.options.mimeType='video/ogg;codecs="opus"':MediaRecorder.isTypeSupported('video/ogg;codecs="vorbis"')?i.options.mimeType='video/ogg;codecs="vorbis"':MediaRecorder.isTypeSupported("video/ogg")?i.options.mimeType="video/ogg":MediaRecorder.isTypeSupported('video/mp4;codecs="mp4a.40.5')?i.options.mimeType='video/mp4;codecs="mp4a.40.5':MediaRecorder.isTypeSupported("video/mp4")&&(i.options.mimeType="video/mp4"):MediaRecorder.isTypeSupported("video/webm")?i.options.mimeType="video/webm":MediaRecorder.isTypeSupported("video/mp4")&&(i.options.mimeType="video/mp4");var t=!1,n=function(e){i.mediaGranted=!0,i.bufferHeader=null;var n=!1;i.mediaRecorder=new MediaRecorder(e,i.options),i.debug&&console.log("MediaRecorder obtained"),i.mediaRecorder.onstart=function(e){i.recording=!0,!1===n&&i.mediaRecorder.requestData()},i.mediaRecorder.ondataavailable=function(e){o.onload=function(){var e=this.result;if(!1===n){if(0==(n=e.byteLength))return n=!1,void setTimeout(function(){i.mediaRecorder.requestData()},1);i.bufferHeader=e,i.onRecordingReady&&i.onRecordingReady(i.bufferHeader),i.recordingReady=!0}else if(i.onBufferProcess){var r=Number(String(Date.now()).slice(-5,-3));i.onBufferProcess([e,r])}},o.readAsArrayBuffer(e.data)},i.mediaRecorder.start(),t=setInterval(function(){i.recordingReady&&i.mediaRecorder.requestData()},r)};i.startRecording=function(){i.mediaGranted&&i.mediaRecorder.stream&&i.mediaRecorder.stream.active?(i.mediaRecorder.start(),i.recording=!0):(i.recordingReady=!1,navigator.mediaDevices.getUserMedia(e).then(n).catch(console.error))},i.stopRecording=function(){if(clearInterval(t),i.mediaRecorder.stop(),i.mediaRecorder.stream.stop)i.mediaRecorder.stream.stop();else for(var e=i.mediaRecorder.stream.getTracks(),r=0;r<e.length;r++)e[r].stop(),i.mediaRecorder.stream.removeTrack(e[r]);i.mediaRecorder.ondataavailable=null,i.mediaRecorder.onstart=null,i.bufferHeader=null,i.recording=!1}},isMobile()){var emptyBuffer=ScarletsMedia.audioContext.createBuffer(1,1,22050),mobileMediaUnlock=function e(r){var i=ScarletsMedia.audioContext.createBufferSource();i.buffer=emptyBuffer,i.connect(ScarletsMedia.audioContext.destination),i.onended=function(){i.disconnect(0),i=emptyBuffer=null,document.removeEventListener("touchstart",e,!0),document.removeEventListener("touchend",e,!0),document.removeEventListener("click",e,!0)},i.start?i.start(0):i.noteOn(0),ScarletsMedia.audioContext.resume()};document.addEventListener("touchstart",mobileMediaUnlock,!0),document.addEventListener("touchend",mobileMediaUnlock,!0),document.addEventListener("click",mobileMediaUnlock,!0)}function isMobile(){return/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(navigator.userAgent)}function objectPropertyLinker(e,r,i){Object.defineProperty(e,i,{get:function(){return r[i]},set:function(e){r[i]=e},enumerable:!0,configurable:!0})}var maxFade=0;function fadeNumber(e,r,i,o,t,n){maxFade=0;var a=e,d=o/(Math.abs(e-r)/Math.abs(i));if(d&&d!=1/0)var u=setInterval(function(){if(maxFade>=100&&clearInterval(u),maxFade++,a=1e3*(a+i),a=Math.ceil(a)/1e3,i>=0&&(a>=r||e>=r)||i<=0&&(a<=r||e<=r)||a==1/0||!a)return clearInterval(u),t(r),void(n&&n());t&&t(a)},d);else setTimeout(function(){t&&t(r),n&&n()},o)}
//# sourceMappingURL=SFMediaStream.min.js.map
