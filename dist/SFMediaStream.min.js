/*
  SFMediaStream
  HTML5 media streamer library for playing music, video, playlist,
  or even live streaming microphone & camera with node server

  https://github.com/ScarletsFiction/SFMediaStream
*/
if(window.ScarletsAudioBufferStreamer=function(e,r){(!e||e<3)&&(e=3),r||(r=1e3);var o=this;o.debug=!1,o.bufferElement=[],o.bufferAvailable=[],o.bufferPending=[],o.currentBuffer=0,o.playing=!1,o.buffering=!1,o.streaming=!1,o.currentDuration=!1,o.latency=0,o.error=0,o.realtime=!1,o.bufferSkip=.07,o.mimeType=null,o.webAudio=!!isMobile(),o.audioContext=ScarletsMedia.audioContext;var i=!1;o.setBufferHeader=function(e){e?(i=e,e.byteLength,o.audioContext&&o.audioContext.decodeAudioData(e.slice(0),function(e){o.bufferSkip=e.duration})):i=!1};for(var t=function(e){o.bufferElement[e].onended=function(){o.debug&&console.log("Buffer ended with ID: "+e),o.webAudio?this.disconnect(0):(URL.revokeObjectURL(o.bufferElement[e].src),o.bufferElement[e].src=""),o.realtime||(o.bufferAvailable[e]=!1,o.playing=!1,o.buffering=!0,o.playAvailable(),-1!=o.bufferAvailable.indexOf(!1)&&0!=o.bufferPending.length&&c())}},n=0;n<e;n++)a(n);function a(e){if(o.webAudio)o.bufferElement.push(o.audioContext.createBufferSource()),o.bufferAvailable.push(!1);else{var r=new Audio;r&&(o.bufferElement.push(r),o.bufferAvailable.push(!1),t(e))}}function d(e,r){var i=o.bufferElement[e].onended;o.bufferElement[e]=o.audioContext.createBufferSource(),o.bufferElement[e].buffer=r,o.bufferElement[e].connect(o.audioContext.destination),o.bufferElement[e].onended=i}o.receiveBuffer=function(i){if(o.debug&&console.log("Receiving data",i[0].byteLength),o.streaming){var t=i[1];if(o.realtime=!1,r){for(var n=o.bufferPending.length,a=0;a<e;a++)o.bufferAvailable[a]&&n++;o.latency=Number(String(Date.now()).slice(-5,-3))-t+r*n+o.audioContext.baseLatency,o.debug&&console.log("Total latency: "+o.latency)}o.bufferPending.push(i[0]),c(),o.buffering&&o.playAvailable()}};var u=new FileReader,f=0;o.realtimeBufferPlay=function(e){o.debug&&console.log("Receiving data",e[0].byteLength),o.latency=Number(String(Date.now()).slice(-5,-3))-e[1]+r/1e3+o.audioContext.baseLatency,o.realtime=!0;var t=f;++f>2&&(f=0),o.webAudio?(u.onload=function(){o.audioContext.decodeAudioData(this.result,function(e){d(t,e),o.bufferElement[t].start(o.bufferSkip)})},u.readAsArrayBuffer(new Blob([i,e[0]],{type:o.mimeType}))):(URL.revokeObjectURL(o.bufferElement[t].src),o.bufferElement[t].src=URL.createObjectURL(new Blob([i,e[0]],{type:o.mimeType})),o.bufferElement[t].load(),o.bufferElement[t].play(),o.bufferElement[t].currentTime=o.bufferSkip)};var c=function(){var e=o.bufferAvailable.indexOf(!1,o.currentBuffer);-1==e&&(e=o.bufferAvailable.indexOf(!1)),-1!=e&&0!=o.bufferPending.length&&(o.webAudio?(u.onload=function(){o.audioContext.decodeAudioData(this.result,function(r){d(e,r)})},u.readAsArrayBuffer(new Blob([i,o.bufferPending[0]],{type:o.mimeType}))):(o.bufferElement[e].src=URL.createObjectURL(new Blob([i,o.bufferPending[0]],{type:o.mimeType})),o.bufferElement[e].load()),o.bufferPending.shift(),o.bufferAvailable[e]=!0,o.buffering&&o.playAvailable(),o.debug&&console.log("Buffer updated with ID: "+e))};o.playBuffer=function(e){o.bufferElement[e].duration&&(o.debug&&console.log("Current stream duration: "+o.bufferElement[e].duration),!1!==r?(o.buffering=!1,o.playing=!0,r=o.bufferElement[e].duration,o.bufferElement[e].start?o.bufferElement[e].start(o.bufferSkip):(o.bufferElement[e].play(),o.bufferElement[e].currentTime=o.bufferSkip),o.currentBuffer=e,o.debug&&console.log("Playing buffer ID: "+o.currentBuffer)):r=o.bufferElement[e].duration)},o.playAvailable=function(){if(!o.playing){if(o.bufferAvailable[o.currentBuffer])return o.playBuffer(o.currentBuffer);var e=o.bufferAvailable.indexOf(!0,o.currentBuffer);return-1!=e?o.playBuffer(e):-1!=(e=o.bufferAvailable.indexOf(!0))?o.playBuffer(e):void 0}},o.playStream=function(){o.streaming=o.buffering=!0},o.stop=function(){o.bufferPending.splice(0);for(var r=0;r<e;r++)o.bufferElement[r].stop(),t(r),o.bufferAvailable[r]=!1;o.playing=!1,o.buffering=!1,o.currentBuffer=0}},window.ScarletsMedia={audioContext:!!window.AudioContext&&new AudioContext},window.ScarletsMediaPlayer=function(e){var r=this,o=["autoplay","loop","buffered","buffered","controller","currentTime","currentSrc","duration","ended","error","readyState","networkState","paused","played","seekable","seeking"];"video"===e.tagName.toLowerCase()&&(o=o.concat(["poster","height","width"])),r.load=function(){e.load()},r.canPlayType=function(){e.canPlayType()};for(var i=0;i<o.length;i++)objectPropertyLinker(r,e,o[i]);r.preload=!0,e.preload="metadata",r.audioFadeEffect=!0,r.speed=function(r){if(void 0===r)return e.defaultPlaybackRate;e.defaultPlaybackRate=e.playbackRate=r},r.mute=function(r){if(void 0===r)return e.muted;e.defaultMuted=e.muted=r};var t=1;r.volume=function(r){if(void 0===r)return t;e.volume=t=r},r.play=function(o){if(e.paused){if(r.audioFadeEffect)return e.volume=0,e.play(),void fadeNumber(0,t,-.05,400,function(r){e.volume=r},o);e.play(),o&&o()}else o&&o()},r.pause=function(o){e.paused?o&&o():r.audioFadeEffect?fadeNumber(t,0,-.05,400,function(r){e.volume=r},function(){e.pause(),o&&o()}):(e.pause(),o&&o())},r.prepare=function(o,i,t){if(!t&&!e.paused)return r.pause(function(){r.prepare(o,i,!0)});for(var n=e.querySelectorAll("source"),a=n.length-1;a>=0;a--)n[a].remove();if("string"==typeof o)e.insertAdjacentHTML("beforeend",'<source src="'+o+'"/>');else{n="";for(a=0;a<o.length;a++)n+='<source src="'+o[a]+'"/>';e.insertAdjacentHTML("beforeend",n)}r.preload&&e.load(),i&&i()};var n={};function a(e){for(var o=0;o<n[e.type].length;o++)n[e.type][o](e,r)}r.on=function(r,o){var i=r.toLowerCase();void 0===n[i]&&(e.addEventListener(r,a,!0),n[i]=[]),n[i].push(o)},r.off=function(r,o){var i=r.toLowerCase();void 0!==n[i]&&(o?n[i].splice(n[i].indexOf(o),1):n[i].splice(0),0===n[i].length&&(n[i]=void 0,e.removeEventListener(r,a,!0)))},r.once=function(r,o){e.addEventListener(r,o,{once:!0})},r.playlist={currentIndex:0,list:[],original:[],loop:!1,shuffled:!1,reload:function(e){this.original=e,this.shuffled&&this.shuffle(!0)},add:function(e){original.push(e),this.shuffled&&this.shuffle(!0)},remove:function(e){original.splice(e,1),this.shuffled&&this.shuffle(!0)},next:function(e){this.currentIndex++,this.play(this.currentIndex)},previous:function(e){this.currentIndex--,this.play(this.currentIndex)},play:function(e){r.prepare(Object.values(this.original[e]),function(){r.play()})},shuffle:function(e){if(void 0===e)return this.shuffled;var r,o,i;if(!0===e)for(i=this.list.length-1;i>0;i--)r=Math.floor(Math.random()*(i+1)),o=this.list[i],this.list[i]=this.list[r],this.list[r]=o;else this.list=this.original.slice(0);this.shuffled=e}}},window.ScarletsMediaPresenter=function(e,r){var o=this;r||(r=1e3),o.debug=!1,o.onRecordingReady=null,o.onBufferProcess=null,o.mediaRecorder=null,o.recordingReady=!1,o.recording=!1,o.mediaGranted=!1;var i=new FileReader;o.options={},e.audio&&!e.video?MediaRecorder.isTypeSupported('audio/webm;codecs="vp9"')?o.options.mimeType='audio/webm;codecs="vp9"':MediaRecorder.isTypeSupported('audio/webm;codecs="vp8"')?o.options.mimeType='audio/webm;codecs="vp8"':MediaRecorder.isTypeSupported('audio/webm;codecs="vorbis"')?o.options.mimeType='audio/webm;codecs="vorbis"':MediaRecorder.isTypeSupported("audio/webm")?o.options.mimeType="audio/webm":MediaRecorder.isTypeSupported('audio/ogg;codecs="opus"')?o.options.mimeType='audio/ogg;codecs="opus"':MediaRecorder.isTypeSupported('audio/ogg;codecs="vorbis"')?o.options.mimeType='audio/ogg;codecs="vorbis"':MediaRecorder.isTypeSupported("audio/ogg")?o.options.mimeType="audio/ogg":MediaRecorder.isTypeSupported('audio/mp4;codecs="mp4a.40.5')?o.options.mimeType='audio/mp4;codecs="mp4a.40.5':MediaRecorder.isTypeSupported("audio/mp4")&&(o.options.mimeType="audio/mp4"):!e.audio&&e.video?MediaRecorder.isTypeSupported('video/webm;codecs="vp9"')?o.options.mimeType='video/webm;codecs="vp9"':MediaRecorder.isTypeSupported('video/webm;codecs="vp8"')?o.options.mimeType='video/webm;codecs="vp8"':MediaRecorder.isTypeSupported('video/webm;codecs="vorbis"')?o.options.mimeType='video/webm;codecs="vorbis"':MediaRecorder.isTypeSupported("video/webm")?o.options.mimeType="video/webm":MediaRecorder.isTypeSupported('video/ogg;codecs="opus"')?o.options.mimeType='video/ogg;codecs="opus"':MediaRecorder.isTypeSupported('video/ogg;codecs="vorbis"')?o.options.mimeType='video/ogg;codecs="vorbis"':MediaRecorder.isTypeSupported("video/ogg")?o.options.mimeType="video/ogg":MediaRecorder.isTypeSupported('video/mp4;codecs="mp4a.40.5')?o.options.mimeType='video/mp4;codecs="mp4a.40.5':MediaRecorder.isTypeSupported("video/mp4")&&(o.options.mimeType="video/mp4"):MediaRecorder.isTypeSupported("video/webm")?o.options.mimeType="video/webm":MediaRecorder.isTypeSupported("video/mp4")&&(o.options.mimeType="video/mp4");var t=!1,n=function(e){o.mediaGranted=!0,o.bufferHeader=null;var n=!1;o.mediaRecorder=new MediaRecorder(e,o.options),o.debug&&console.log("MediaRecorder obtained"),o.mediaRecorder.onstart=function(e){o.recording=!0,!1===n&&o.mediaRecorder.requestData()},o.mediaRecorder.ondataavailable=function(e){i.onload=function(){var e=this.result;if(!1===n){if(0==(n=e.byteLength))return n=!1,void setTimeout(function(){o.mediaRecorder.requestData()},1);o.bufferHeader=e,o.onRecordingReady&&o.onRecordingReady(o.bufferHeader),o.recordingReady=!0}else if(o.onBufferProcess){var r=Number(String(Date.now()).slice(-5,-3));o.onBufferProcess([e,r])}},i.readAsArrayBuffer(e.data)},o.mediaRecorder.start(),t=setInterval(function(){o.recordingReady&&o.mediaRecorder.requestData()},r)};o.startRecording=function(){o.mediaGranted&&o.mediaRecorder.stream&&o.mediaRecorder.stream.active?(o.mediaRecorder.start(),o.recording=!0):(o.recordingReady=!1,navigator.mediaDevices.getUserMedia(e).then(n).catch(console.error))},o.stopRecording=function(){if(clearInterval(t),o.mediaRecorder.stop(),o.mediaRecorder.stream.stop)o.mediaRecorder.stream.stop();else for(var e=o.mediaRecorder.stream.getTracks(),r=0;r<e.length;r++)e[r].stop(),o.mediaRecorder.stream.removeTrack(e[r]);o.mediaRecorder.ondataavailable=null,o.mediaRecorder.onstart=null,o.bufferHeader=null,o.recording=!1}},isMobile()){var emptyBuffer=ScarletsMedia.audioContext.createBuffer(1,1,22050),mobileMediaUnlock=function e(r){var o=ScarletsMedia.audioContext.createBufferSource();o.buffer=emptyBuffer,o.connect(ScarletsMedia.audioContext.destination),o.onended=function(){o.disconnect(0),o=emptyBuffer=null,document.removeEventListener("touchstart",e,!0),document.removeEventListener("touchend",e,!0),document.removeEventListener("click",e,!0)},o.start?o.start(0):o.noteOn(0),ScarletsMedia.audioContext.resume()};document.addEventListener("touchstart",mobileMediaUnlock,!0),document.addEventListener("touchend",mobileMediaUnlock,!0),document.addEventListener("click",mobileMediaUnlock,!0)}function isMobile(){return/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(navigator.userAgent)}function objectPropertyLinker(e,r,o){Object.defineProperty(e,o,{get:function(){return r[o]},set:function(e){r[o]=e},enumerable:!0,configurable:!0})}var maxFade=0;function fadeNumber(e,r,o,i,t,n){maxFade=0;var a=e,d=i/(Math.abs(e-r)/Math.abs(o));if(d&&d!=1/0)var u=setInterval(function(){if(maxFade>=100&&clearInterval(u),maxFade++,a=1e3*(a+o),a=Math.ceil(a)/1e3,o>=0&&(a>=r||e>=r)||o<=0&&(a<=r||e<=r)||a==1/0||!a)return clearInterval(u),t(r),void(n&&n());t&&t(a)},d);else setTimeout(function(){t&&t(r),n&&n()},i)}
//# sourceMappingURL=SFMediaStream.min.js.map
